# Miraluna Valencia — Real Estate Platform

A high-performance, multilingual real estate aggregator for Valencia and Spain.

**Live:** [miralunavalencia.com](https://miralunavalencia.com)
**Stack:** Next.js 14, Supabase, TypeScript, Tailwind CSS, Vercel

---

## Features

- **Multi-language** (ES/EN/RU) — Full i18n with language selector
- **Server-Side Pagination** — 24 items/page, URL state, shareable filters
- **ISR Caching** — Homepage & category pages: 5min revalidation; CDN-cached
- **SEO** — Locality-based URLs, dynamic metadata, JSON-LD structured data, sitemap
- **Full-Text Search** — Spanish tsvector search + price/bedroom/type filters
- **Analytics** — View tracking (deduped), save counts via DB triggers
- **Image Optimization** — next/image with WebP, lazy loading
- **Mobile-First** — Responsive, snap-scroll carousels

---

## Quick Start

```bash
npm install
npm run dev       # http://localhost:3000
npm run build     # Production build
```

**Environment Variables** (`.env.local`):
```env
# Public
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...

# Server-only
SUPABASE_SERVICE_ROLE_KEY=eyJ...       # Used by /api/revalidate
REVALIDATE_SECRET=your-random-secret   # Used by /api/revalidate auth
```

---

## Project Structure

```
app/
  page.tsx                      # Homepage (ISR: 5min)
  categoria/
    venta|alquiler|obra-nueva/  # Category pages (ISR: 5min)
  [region]/[province]/
    [municipality]/[category]/
      [slug]/                   # SEO property detail pages
  propiedad/[id]/               # Legacy property detail (fallback)
  buscar/                       # Search page (force-dynamic)
  profile/                      # User profile (client)
  api/
    revalidate/                 # Cache invalidation endpoint
    track-view/                 # View tracking (beacon)

components/                     # React components
lib/
  i18n.tsx                      # Translation system
  seo.ts                        # SEO utilities (getPropertyHref, metadata)
  utils.ts                      # formatPrice, slugify, cn(), etc.
  supabase/
    queries.ts                  # Client-side DB queries
    server-queries.ts           # Server-side DB queries (ISR-aware)

data/properties.ts              # Property interface + static fallback
scripts/SCRAPER_FIELD_GUIDE.md  # Scraper upload reference
docs/                           # Architecture documentation
```

---

## Database

Clean, minimal schema. See `docs/DATABASE.md` for full details.

```
properties          ← Main table
translations        ← Optional EN/RU translations
saved_properties    ← User favourites
property_analytics  ← Event log (views, saves)
card_properties     ← Materialized view (fast listing display)
```

**Setup (new DB):**
```bash
psql $DATABASE_URL < database-clean-schema.sql
```

---

## ISR Caching Strategy

```typescript
// Homepage — 5 minute refresh
export const revalidate = 300;

// Category pages — 5 minute refresh
export const revalidate = 300;

// Search — always fresh (URL-param driven)
export const dynamic = 'force-dynamic';
```

**Invalidate cache manually:**
```bash
curl -X POST https://miraluna.es/api/revalidate \
  -H "x-revalidate-secret: YOUR_REVALIDATE_SECRET" \
  -H "Content-Type: application/json" \
  -d '{"clearAll": true}'
```

---

## After Bulk Property Upload

1. `SELECT refresh_card_properties();` — in Supabase SQL editor
2. POST to `/api/revalidate` — flushes ISR cache for all category pages

---

## SEO URL Format

```
/{region}/{province}/{municipality}/{category}/{slug}
/comunidad-valenciana/alicante/javea/venta/villa-moderna-idealista-12345
```

Generated by `getPropertyHref(property)` in `lib/seo.ts`.
Falls back to `/propiedad/{id}` when location data is missing.

---

## Scraping Integration

```typescript
await supabase.from('properties').upsert({
  id: 'idealista-12345',
  listing_type: 'sale',      // 'sale' | 'rent' | 'new-building'
  sub_category: 'apartment', // 'apartment' | 'house' | 'commerce' | 'plot'
  title: 'Piso en Valencia Centro',
  price: 185000,
  location: 'Valencia, Ciutat Vella',
  municipality: 'Valencia',
  province: 'Valencia',
  region: 'Comunidad Valenciana',
  images: ['https://...'],
  specs: { bedrooms: 3, bathrooms: 2, size: 95 },  // Numbers, 'size' key
  source: 'idealista',
  source_id: '12345'
}, { onConflict: 'source,source_id' });
```

See `scripts/SCRAPER_FIELD_GUIDE.md` for full field reference.

---

## Documentation

| File | Description |
|------|-------------|
| `docs/DATABASE.md` | Schema, tables, functions, query patterns |
| `docs/ARCHITECTURE.md` | System design, rendering strategy, ISR |
| `docs/TRANSLATION.md` | i18n implementation |
| `docs/COMPONENTS.md` | Component patterns |
| `docs/DATA_FLOW.md` | How data moves through the app |
| `PERFORMANCE.md` | Caching, optimization details |

---

## Deployment

```bash
vercel --prod
```

**DNS (Vercel):**
- `A @` → `76.76.21.21`
- `CNAME www` → `cname.vercel-dns.com`

---

## License

Proprietary — All rights reserved
